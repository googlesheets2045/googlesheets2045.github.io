<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sandiwangi</title>
    
    <!-- Favicon -->
    <link rel="icon" href="https://upload.wikimedia.org/wikipedia/commons/thumb/9/90/Lambang_Kodam_Siliwangi.png/64px-Lambang_Kodam_Siliwangi.png" type="image/x-icon">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#007bff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Sandiwangi">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="description" content="Aplikasi Sandiwangi">
    
    <!-- Manifest -->
    <link rel="manifest" href="./manifest.json">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body, html {
            height: 100%;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* Install Prompt */
        #installPrompt {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            text-align: center;
            z-index: 1000;
            border: 2px solid #007bff;
            max-width: 90%;
            width: 350px;
        }

        #installPrompt h3 {
            margin-bottom: 10px;
            color: #333;
        }

        #installPrompt p {
            margin-bottom: 15px;
            color: #666;
            font-size: 14px;
        }

        #installPrompt button {
            padding: 8px 16px;
            margin: 0 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        #installApp {
            background: #007bff;
            color: white;
        }

        #dismissApp {
            background: #6c757d;
            color: white;
        }

        /* Manual Install Button */
        #manualInstallBtn {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1001;
            font-size: 12px;
        }

        /* Loading */
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Manual Install Button (Visible for testing) -->
    <button id="manualInstallBtn" style="display: none;">üì≤ Install App</button>

    <!-- Loading Screen -->
    <div id="loading">
        <div class="spinner"></div>
        <p>Memuat Sandiwangi...</p>
    </div>

    <!-- Main App -->
    <iframe 
        id="appFrame"
        src="https://script.google.com/macros/s/AKfycbynGD1rfN8nlcbcRqdqMb3t5ADYI1qEKAu303Z37mEd3TMok5BbtGIoEAtdoLDdPCaZ/exec"
        sandbox="allow-scripts allow-same-origin allow-forms allow-popups"
        style="display: none;">
    </iframe>

    <!-- Install Prompt -->
    <div id="installPrompt" style="display: none;">
        <h3>üì± Install Sandiwangi</h3>
        <p>Install aplikasi untuk pengalaman yang lebih baik</p>
        <button id="installApp">Install</button>
        <button id="dismissApp">Nanti</button>
    </div>

    <script>
        // Elements
        const loading = document.getElementById('loading');
        const appFrame = document.getElementById('appFrame');
        const installPrompt = document.getElementById('installPrompt');
        const installAppBtn = document.getElementById('installApp');
        const dismissAppBtn = document.getElementById('dismissApp');
        const manualInstallBtn = document.getElementById('manualInstallBtn');

        let installPromptEvent;

        // Check if app is already installed
        function isAppInstalled() {
            return window.matchMedia('(display-mode: standalone)').matches || 
                   window.navigator.standalone ||
                   document.referrer.includes('android-app://');
        }

        // Show install prompt
        function showInstallPrompt() {
            if (!isAppInstalled() && installPromptEvent) {
                installPrompt.style.display = 'block';
                manualInstallBtn.style.display = 'block';
            }
        }

        // Hide loading when iframe loads
        appFrame.addEventListener('load', function() {
            setTimeout(() => {
                loading.style.display = 'none';
                appFrame.style.display = 'block';
                
                // Show install prompt after app loads
                setTimeout(showInstallPrompt, 2000);
            }, 1500);
        });

        // Handle beforeinstallprompt event
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('‚úÖ beforeinstallprompt event fired!');
            e.preventDefault();
            installPromptEvent = e;
            manualInstallBtn.style.display = 'block';
        });

        // Install button click
        installAppBtn.addEventListener('click', async () => {
            if (!installPromptEvent) {
                alert('Fitur install tidak tersedia. Pastikan Anda mengakses melalui HTTPS.');
                return;
            }

            installPromptEvent.prompt();
            const { outcome } = await installPromptEvent.userChoice;
            
            if (outcome === 'accepted') {
                installPrompt.style.display = 'none';
                manualInstallBtn.style.display = 'none';
            }
            
            installPromptEvent = null;
        });

        // Dismiss button click
        dismissAppBtn.addEventListener('click', () => {
            installPrompt.style.display = 'none';
            // Show again after 1 day
            localStorage.setItem('installDismissed', Date.now());
        });

        // Manual install button
        manualInstallBtn.addEventListener('click', () => {
            if (installPromptEvent) {
                installPromptEvent.prompt();
            } else {
                // Show instructions for manual install
                alert(`Untuk install aplikasi:
1. Di Chrome: Tap menu (‚ãÆ) ‚Üí "Add to Home screen"
2. Di Safari: Tap share icon (‚ñ°‚Üë) ‚Üí "Add to Home Screen"
3. Di Firefox: Tap menu (‚ãÆ) ‚Üí "Install"`);
            }
        });

        // App installed event
        window.addEventListener('appinstalled', () => {
            console.log('üéâ App installed!');
            installPrompt.style.display = 'none';
            manualInstallBtn.style.display = 'none';
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Sandiwangi App Started');
            
            // Check if already installed
            if (isAppInstalled()) {
                console.log('üì± App running as PWA');
                installPrompt.style.display = 'none';
                manualInstallBtn.style.display = 'none';
            }

            // Show manual install button if no prompt after 5 seconds
            setTimeout(() => {
                if (!installPromptEvent && !isAppInstalled()) {
                    manualInstallBtn.style.display = 'block';
                }
            }, 5000);

            // Hide loading after timeout (fallback)
            setTimeout(() => {
                loading.style.display = 'none';
                appFrame.style.display = 'block';
            }, 10000);
        });

        // Online/Offline handling
        window.addEventListener('online', () => {
            console.log('üåê Online');
        });

        window.addEventListener('offline', () => {
            console.log('‚ùå Offline');
            alert('Koneksi internet terputus');
        });
    </script>
</body>
</html>
